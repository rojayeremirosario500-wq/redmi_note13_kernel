name: Compilar Kernel 5.15 ZEPHYR

on:
  # Permite ejecutarlo manualmente desde la pestana Actions
  workflow_dispatch:
  # Ejecuta al subir cambios a la rama 'main'
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout del codigo fuente (el tuyo, en la raiz)
    - name: Checkout Code
      uses: actions/checkout@v4
      
    # 2. Uso de la accion de compilacion del creador del kernel
    - name: Usar Kernel Builder para Compilar
      uses: topnotchfreaks/kernel-builder@main
      with:
        # Tu codigo fuente esta en la raiz del repo (./)
        kernel_source_url: './'
        
        # Le indicamos que branch usar, aunque al ser local es irrelevante
        kernel_branch: main
        
        # Le indicamos el defconfig que debe usar para el Redmi Note 13
        # Asumo que es 'msm_defconfig', si falla, es el primer valor que cambiaremos.
        device: msm_defconfig
        
        # Configuracion de la toolchain (Clang/LLVM)
        toolchain_url: 'https://github.com/crdroid-r/clang/releases/download/17.0.6-20240315/clang-r510526-android-17-06.tar.gz'
        toolchain_path: toolchain/clang
        
        # Banderas de compilacion para forzar CLANG
        compiler: clang
        
        # Optimizacion de enlace (si el kernel lo soporta)
        lto_mode: thin

    # 3. Empaquetar y Subir Archivos de Salida
    - name: Empaquetar y Subir Archivos de Salida
      uses: actions/upload-artifact@v4
      with:
        name: Kernel_ZEPHYR_Compilado
        # La accion de compilacion guarda el zip final en el directorio raiz
        path: "*.zip"
        if-no-files-found: warn
