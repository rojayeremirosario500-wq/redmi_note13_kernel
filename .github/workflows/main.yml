name: Compilar Kernel 5.15 ZEPHYR

on:
  # Permite ejecutarlo manualmente desde la pestana Actions
  workflow_dispatch:
  # Ejecuta al subir cambios a la rama 'main'
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Instalar Dependencias del Sistema
      run: sudo apt update && sudo apt install -y git build-essential bison flex libssl-dev libncurses5-dev wget unzip

    # --- PASO CRITICO: DESCARGA AUTOMATICA DEL TOOLCHAIN ---
    - name: Descargar Toolchain de Google (Clang NDK r25c)
      run: |
        # Definimos el directorio donde estara la toolchain (como si la hubieras subido)
        TOOLCHAIN_DIR="toolchain/aarch64-linux-android"
        mkdir -p "$TOOLCHAIN_DIR/bin"
        
        # URL de la Toolchain oficial de Android NDK (Clang)
        TOOLCHAIN_URL="https://dl.google.com/android/repository/android-ndk-r25c-linux.zip"
        
        echo "Descargando NDK r25c..."
        wget -O ndk.zip $TOOLCHAIN_URL
        
        echo "Descomprimiendo NDK (Esto tarda ~1 min)..."
        unzip -q ndk.zip -d ndk_temp
        
        # Mover los archivos binarios del compilador a la ruta esperada
        mv ndk_temp/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/* "$TOOLCHAIN_DIR/bin"
        
        # Limpiar archivos temporales
        rm -rf ndk_temp ndk.zip
    
    # --- CONFIGURACION DE ENTORNO ---
    - name: Definir Entorno y Preparar Toolchain
      run: |
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        # 1. Crear un enlace simbolico para que 'make' encuentre el compilador por su nombre clasico
        ln -s $(pwd)/toolchain/aarch64-linux-android/bin/clang $(pwd)/toolchain/aarch64-linux-android/bin/aarch64-linux-android-gcc
        
        # 2. AÃ±ade la Toolchain a PATH para que se reconozca globalmente
        export PATH=$(pwd)/toolchain/aarch64-linux-android/bin:$PATH
        
    # --- PASO CRITICO: USAR EL BUILDER DEL CREADOR ---
    - name: Integrar y Ejecutar Builder de Topnotchfreaks
      run: |
        # 1. Clonar el repositorio del builder a una carpeta temporal
        git clone https://github.com/topnotchfreaks/kernel-msm-5.15 builder_scripts
        
        # 2. Copiar los scripts de compilacion necesarios a la raiz de tu repo (donde estan los archivos del kernel)
        cp builder_scripts/build.sh .
        cp builder_scripts/build-config.sh .
        
        # 3. Dar permisos de ejecucion
        chmod +x build.sh
        
        # 4. EJECUTAR EL SCRIPT DE COMPILACION
        # El script necesita el nombre del defconfig como argumento.
        echo "Ejecutando build.sh con msm_defconfig..."
        # Si esto falla, el error sera el mensaje del creador del kernel
        bash ./build.sh msm_defconfig
        
    - name: Empaquetar y Subir Archivos de Salida
      uses: actions/upload-artifact@v4
      with:
        name: Kernel_ZEPHYR_Compilado
        # Buscamos la salida generada por el script 'build.sh'
        path: out/arch/arm64/boot/*
        if-no-files-found: warn
